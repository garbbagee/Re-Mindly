<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button autoHide="false"></ion-menu-button>
    </ion-buttons>
    <ion-title>Mis Tareas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen class="feed-content" id="main-content">
  <!-- Estadísticas -->
  <ion-card class="stats-card">
    <ion-card-content>
      <div class="stats-container">
        <div class="stat-item">
          <div class="stat-number">{{ pendingTasks.length }}</div>
          <div class="stat-label">Pendientes</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ completedTasks.length }}</div>
          <div class="stat-label">Completadas</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ overdueTasks.length }}</div>
          <div class="stat-label">Vencidas</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ tasks.length }}</div>
          <div class="stat-label">Total</div>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Tareas Vencidas -->
  <ion-card *ngIf="overdueTasks.length > 0" class="overdue-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="warning-outline"></ion-icon>
        Tareas Vencidas ({{ overdueTasks.length }})
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item *ngFor="let task of overdueTasks" class="task-item overdue">
          <ion-checkbox 
            slot="start" 
            (ionChange)="toggleTask(task)"
            [checked]="task.completed">
          </ion-checkbox>
          
          <ion-label class="task-content">
            <h3>{{ task.title }}</h3>
            <p *ngIf="task.description">{{ task.description }}</p>
            <div class="task-meta">
              <ion-badge [color]="getPriorityColor(task.priority)">
                {{ getPriorityText(task.priority) }}
              </ion-badge>
              <ion-badge color="danger" *ngIf="task.dueDate">
                {{ formatDateForDisplay(task.dueDate) }}
              </ion-badge>
              <span class="task-date">
                {{ task.createdAt | date:'shortDate' }}
              </span>
            </div>
          </ion-label>
          
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="editTask(task)">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="danger" (click)="deleteTask(task)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Tareas Pendientes -->
  <ion-card *ngIf="pendingTasks.length > 0">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="time-outline"></ion-icon>
        Tareas Pendientes ({{ pendingTasks.length }})
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item *ngFor="let task of pendingTasks" class="task-item">
          <ion-checkbox 
            slot="start" 
            (ionChange)="toggleTask(task)"
            [checked]="task.completed">
          </ion-checkbox>
          
          <ion-label class="task-content">
            <h3>{{ task.title }}</h3>
            <p *ngIf="task.description">{{ task.description }}</p>
            <div class="task-meta">
              <ion-badge [color]="getPriorityColor(task.priority)">
                {{ getPriorityText(task.priority) }}
              </ion-badge>
              <ion-badge 
                [color]="isOverdue(task) ? 'danger' : 'primary'" 
                *ngIf="task.dueDate">
                {{ formatDateForDisplay(task.dueDate) }}
              </ion-badge>
              <span class="task-date">
                {{ task.createdAt | date:'shortDate' }}
              </span>
            </div>
          </ion-label>
          
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="editTask(task)">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="danger" (click)="deleteTask(task)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Tareas Completadas -->
  <ion-card *ngIf="completedTasks.length > 0">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        Tareas Completadas ({{ completedTasks.length }})
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item *ngFor="let task of completedTasks" class="task-item completed">
          <ion-checkbox 
            slot="start" 
            (ionChange)="toggleTask(task)"
            [checked]="task.completed">
          </ion-checkbox>
          
          <ion-label class="task-content">
            <h3 class="completed-text">{{ task.title }}</h3>
            <p *ngIf="task.description" class="completed-text">{{ task.description }}</p>
            <div class="task-meta">
              <ion-badge [color]="getPriorityColor(task.priority)">
                {{ getPriorityText(task.priority) }}
              </ion-badge>
              <ion-badge color="success" *ngIf="task.dueDate">
                Completada
              </ion-badge>
              <span class="task-date">
                {{ task.createdAt | date:'shortDate' }}
              </span>
            </div>
          </ion-label>
          
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="editTask(task)">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="danger" (click)="deleteTask(task)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Mensaje cuando no hay tareas -->
  <ion-card *ngIf="tasks.length === 0" class="empty-state">
    <ion-card-content>
      <div class="empty-content">
        <ion-icon name="list-outline" size="large"></ion-icon>
        <h3>No tienes tareas aún</h3>
        <p>Comienza agregando tu primera tarea usando el botón flotante</p>
        <ion-button (click)="openAddTaskModal()">
          <ion-icon name="add" slot="start"></ion-icon>
          Agregar Primera Tarea
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Botón flotante para agregar tarea -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openAddTaskModal()" class="add-task-fab">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<!-- Modal para agregar nueva tarea -->
<ion-modal [isOpen]="isAddingTask" (didDismiss)="closeAddTaskModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Nueva Tarea</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeAddTaskModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="modal-content">
      <div class="modal-form">
        <ion-item>
          <ion-label position="stacked">Título *</ion-label>
          <ion-input 
            [(ngModel)]="newTaskTitle" 
            placeholder="Ingresa el título de la tarea"
            clearInput="true">
          </ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Descripción</ion-label>
          <ion-textarea 
            [(ngModel)]="newTaskDescription" 
            placeholder="Descripción opcional de la tarea"
            rows="3">
          </ion-textarea>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Fecha de vencimiento</ion-label>
          <ion-datetime 
            [(ngModel)]="newTaskDueDate"
            presentation="date-time"
            placeholder="Selecciona fecha y hora (opcional)">
          </ion-datetime>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Prioridad</ion-label>
          <ion-select [(ngModel)]="newTaskPriority">
            <ion-select-option value="low">Baja</ion-select-option>
            <ion-select-option value="medium">Media</ion-select-option>
            <ion-select-option value="high">Alta</ion-select-option>
          </ion-select>
        </ion-item>
        
        <div class="modal-buttons">
          <ion-button fill="outline" (click)="closeAddTaskModal()">
            Cancelar
          </ion-button>
          <ion-button (click)="addTask()">
            Agregar Tarea
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-menu side="start" menuId="main-menu" contentId="main-content">
  <ion-header class="menu-header">
    <div class="profile-container">
      <div class="profile-avatar">{{ userInitial }}</div>
      <div class="profile-name">{{ userName }}</div>
    </div>
  </ion-header>

  <ion-content>
    <ion-list>
      <ion-item button routerLink="/feed" routerDirection="root">
        <ion-icon slot="start" name="home-outline"></ion-icon>
        <ion-label>Todas mis tareas</ion-label>
      </ion-item>

      <ion-item button routerLink="/progress" routerDirection="root">
        <ion-icon slot="start" name="stats-chart-outline"></ion-icon>
        <ion-label>Progreso</ion-label>
      </ion-item>

      <ion-item button (click)="testNotification()">
        <ion-icon slot="start" name="notifications-outline"></ion-icon>
        <ion-label>Probar Notificación</ion-label>
      </ion-item>

      <ion-item button routerLink="/settings" routerDirection="root">
        <ion-icon slot="start" name="settings-outline"></ion-icon>
        <ion-label>Configuración</ion-label>
      </ion-item>

      <ion-item button (click)="logout()">
        <ion-icon slot="start" name="log-out-outline"></ion-icon>
        <ion-label>Cerrar sesión</ion-label>
      </ion-item>
    </ion-list>
  </ion-content>
</ion-menu>
